# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# _______ _______ _     _ _     _
#    |    |  |  | |     |  \___/    @rstacruz's
#    |    |  |  | |_____| _/   \_   tmux configuration
# 
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# ┌───────┬───────┬───────┬───────┬───────┐┌───────┬───────┬───────┬───────┬───────┐
# │     Q │     W │     F │     P │     B ││     J │     L │     U │     Y │  Bksp │
# │ reload│       │pane ← │pane → │ toggle││       │       │       │       │       │
# ├───────┼───────┼───────┼───────┼───────┤├───────┼───────┼───────┼───────┼───────┤
# │     A │     R │     S │     T │     G ││     M │     N │     E │     I │     O │
# │ ▓▓    │ rename│hsplit │ tab ← │ tab → ││       │pane → │       │       │rotate │
# ├───────┼───────┼───────┼───────┼───────┤├───────┼───────┼───────┼───────┼───────┤
# │     Z │     X │     C │     D │     V ││     K │     H │     , │     . │       │
# │       │ close │ tab + │pick...│vsplit ││       │       │       │       │       │
# └───────┴───────┴───────┴───┬───┴───────┘└───────┴───┬───┴───────┴───────┴───────┘
#                             │                  Space │
#                             │                        │
#                             └────────────────────────┘
# Non-ctrl:
#   t (time), b (bar toggle)
#
# ━━ Tmux plugin manager ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ {{{

set -g @plugin 'tmux-plugins/tpm' # tmux plugin manager
set -g @plugin 'tmux-plugins/tmux-sensible' # default settings
set -g @plugin 'tmux-plugins/tmux-yank' # `y` in visual mode to copy to clipboard

# }}}
# ━━ Options ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ {{{

# https://github.com/tmux/tmux/wiki/FAQ#i-dont-see-italics-or-italics-and-reverse-are-the-wrong-way-round
#
#   Feature          tmux-256  screen-256  kitty
#   -
#   Vim backgrounds  OK        nah         ?
#   ag + less        nah       OK          OK  ("warning: not a functioning terminal")
#   home/end on mac  nah       OK          nah??
#   italic           OK        nah         OK
#   undercurl        nah       nah         OK

# set -g default-terminal "screen-256color"
set -g default-terminal "${TERM}"

# https://stackoverflow.com/questions/18600188/home-end-keys-do-not-work-in-tmux
bind-key -n Home send Escape "OH"
bind-key -n End send Escape "OF"

# https://github.com/neovim/neovim/issues/7764#issuecomment-411995268
# Fixes Neovim background colors
#set -g default-terminal "tmux-256color"
# set -g terminal-overrides ',xterm-256color:Tc'
# set -as terminal-overrides ',xterm*:sitm=\E[3m'
# set -g terminal-overrides ',screen-256color:Tc'
# set -as terminal-overrides ',screen*:sitm=\E[3m'

# Undercurl
# https://github.com/folke/lsp-colors.nvim#making-undercurls-work-properly-in-tmux
# set -g default-terminal "${TERM}"
# set -g default-terminal "tmux-256color"
# set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
# set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0

setw -g mode-keys vi # Vi mode in status and copy mode
set -g base-index 1 # Start tab numbering at 1 instead of 0
set -g repeat-time 100
set -g escape-time 0 # Fix emacs/vim escape delay
setw -g monitor-activity on # Highlight tabs with activity
set -g visual-bell off # No bell
set -g visual-activity off
set -g clock-mode-style 12 # 12-hour clock mode (^B t)
setw -g main-pane-width 110 # For main-horizontal mode (^B M-4), the width of the main left pane
set -g mouse on # Mouse support
set -g renumber-windows on # Auto-compact the window numbers
set -g prefix C-a

# Auto-rename windows based on current path
# https://stackoverflow.com/a/45010147
set -g status-interval 5
set -g automatic-rename on
set -g automatic-rename-format '#{b:pane_current_path}'

# }}}
# ━━ Keys ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ {{{

bind -r ^s split-window -c '#{pane_current_path}' # horiz split
bind -r ^v split-window -h -c '#{pane_current_path}' # vert split
bind -r ^c neww -c '#{pane_current_path}' # new tab
bind -r ^n select-pane -t :.+
bind -r ^f select-pane -t :.+
bind -r ^p select-pane -t :.+
bind -r ^g next-window # next tab
bind -r ^t previous-window # prev tab
bind -r ^w choose-window
bind -r ^d choose-window
bind -r ^x kill-pane
bind -r ^q source-file ~/.tmux.conf

# Session/window management.
# (these shortcuts line up nicely with the default ^B !)
bind "@" command-prompt -p "Send pane to window:" "join-pane -t '%%'"
bind "#" command-prompt -p "New session:" "new-session -s '%%'"
bind "*" confirm-before -p "Kill the session? (y/n)" "kill-session"

# Change these to not have default values
unbind-key ","  ; bind "," command-prompt "rename-window '%%'"
unbind-key "'"  ; bind "'" command-prompt "select-window -t '%%'"
unbind-key "\$" ; bind "\$" command-prompt "rename-session '%%'"
bind ^r command-prompt "rename-window '%%'"

bind-key = set-window-option synchronize-panes # https://github.com/peikk0/tmux-cssh

# }}# Make them repeatable
unbind-key "{" ; bind -r "{" swap-pane -U
unbind-key "}" ; bind -r "}" swap-pane -D

bind ^b set -g status # Toggle status bar
bind -r T command-prompt -p "New tab:" "new-window -n '%%'" # New tab with name
unbind x; bind -r x kill-pane # No confirmation for ^B x

# bind-key C-Tab next-window
# bind-key C-S-Tab previous-window
# bind-key C-PgDn next-window
# bind-key C-PgUp previous-window

bind-key -n C-0 select-window -t :0
bind-key -n C-1 select-window -t :1
bind-key -n C-2 select-window -t :2
bind-key -n C-3 select-window -t :3
bind-key -n C-4 select-window -t :4
bind-key -n C-5 select-window -t :5
bind-key -n C-6 select-window -t :6
bind-key -n C-7 select-window -t :7
bind-key -n C-8 select-window -t :8
bind-key -n C-9 select-window -t :9

# }}}
# ━━ F12 - passthru mode ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ {{{
# Thanks https://github.com/samoshkin/tmux-config/blob/master/tmux/tmux.conf#L363

bind -T root F12 \
  set prefix None \; \
  set key-table off \; \
  set -g status on \; \
  set status-right '(passthru mode - F12 to exit)' \; \
  setw -g window-status-format ' ' \; \
  setw -g window-status-current-format ' ' \; \
  refresh-client -S \;

bind -T off F12 \
  set -u prefix \; \
  set -u key-table \; \
  set -u status-right \; \
  source-file ~/.tmux.conf \; \
  refresh-client -S \;

# }}}
# ━━ Theme ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ {{{

# Lines between panes
set -g pane-border-style 'fg=colour8'
set -g pane-active-border-style 'fg=colour1'

# Status bar styles
set -g clock-mode-colour '#888888'
set -g status-style 'fg=colour8'
setw -g message-style 'fg=blue'
setw -g window-status-style 'fg=colour8'
setw -g window-status-current-style 'fg=colour2'
setw -g window-status-activity-style ''

# Status format
set -g status-right '╱  #[fg=colour1]#S '
# if-shell 'test -n "$SSH_TTY"' "set -g status-right '#[fg=blue]#S #[fg=555555] -  #[fg=green]#(hostname)'"
if-shell 'test -n "$SSH_TTY"' "set -g status-right '#[fg=blue]  #S #[fg=green]#(hostname)'"
set -g status-left ' '

# Tabs
setw -g window-status-separator '#[fg=colour8]╱'
setw -g window-status-current-format '#[fg=colour4,bold]  #W⁺ '
setw -g window-status-format '#[fg=colour8]  #W  '

# setw -g window-status-current-format '#[fg=colour4] #[fg=colour2]#I#[fg=colour4]┄#W ' # with number
# setw -g window-status-format ' #[fg=colour2]#I#[fg=colour8]┄#W '

# Status line options
set -g status-position bottom
set -g status-justify centre
set -g status-interval 10
set -g status-right-length 100
set -g status-left-length 100

# }}}
# ━━ End ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ {{{

if-shell 'test -e ~/.config/tmux/tmuxrc.local' 'source-file ~/.config/tmux/tmuxrc.local' # Local 
if-shell 'test -e ~/.config/tmux/plugins/tpm' 'run "~/.config/tmux/plugins/tpm/tpm"' # Tmux plugin manager
if-shell 'test -e ~/.tmux/tmuxrc.local' 'source-file ~/.tmux/tmuxrc.local' # Local 
if-shell 'test -e ~/.tmux/plugins/tpm' 'run "~/.tmux/plugins/tpm/tpm"' # Tmux plugin manager

if-shell 'test -x /opt/homebrew/bin/fish' 'set -g default-command /opt/homebrew/bin/fish'
if-shell 'test -x /opt/homebrew/bin/fish' 'set -g default-shell /opt/homebrew/bin/fish'

# 
# vim:foldmethod=marker
# }}}
